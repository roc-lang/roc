on:
  workflow_call:
  workflow_dispatch:

name: Zig Interpreter Benchmarks

# Do not add permissions here! Configure them at the job level!
permissions: {}

jobs:
  zig-benchmarks:
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 90
    steps:
      # === MAIN BRANCH BUILD ===
      - name: Checkout main branch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
        with:
          ref: "main"
          clean: "true"

      - uses: mlugg/setup-zig@8d6198c65fb0feaa111df26e6b467fea8345e46f # ratchet:mlugg/setup-zig@v2.0.5
        with:
          version: 0.15.2
          use-cache: true

      - name: Verify prerequisites
        run: |
          hyperfine --version
          jq --version

      - name: Build main branch release binary and snapshot tool
        uses: ./.github/actions/flaky-retry
        with:
          command: "zig build release snapshot -Doptimize=ReleaseFast"
          error_string_contains: "build.zig.zon"
          retry_count: 3

      - name: Prepare main artifacts
        run: |
          mkdir -p bench-main
          cp zig-out/bin/roc bench-main/roc
          cp zig-out/bin/snapshot bench-main/snapshot

      # === PR BRANCH BUILD ===
      - name: Checkout PR branch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
        with:
          clean: "false"

      - name: Build PR branch release binary and snapshot tool
        uses: ./.github/actions/flaky-retry
        with:
          command: "zig build release snapshot -Doptimize=ReleaseFast"
          error_string_contains: "build.zig.zon"
          retry_count: 3

      - name: Prepare PR artifacts
        run: |
          mkdir -p bench-pr
          cp zig-out/bin/roc bench-pr/roc
          cp zig-out/bin/snapshot bench-pr/snapshot

      # === RUN BENCHMARKS ===
      - name: Run benchmarks
        run: ./ci/benchmarks_zig/run_local_benchmarks.sh --main-dir bench-main --pr-dir bench-pr