on: [pull_request] 
name: CI

jobs:
  test:
    name: fmt, clippy, test, test --release
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v1

      - name: Install Nix
        uses: cachix/install-nix-action@v12

      - name: Use Cachix
        uses: cachix/cachix-action@v8
        with:
          name: signingKey
          authToken: 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJjJDIwNzgiLCJqdGkiOiI5MWM2NGQyZS04NjdjLTQzYjItOTAyYS1iMTgwOTlkYjc4ZDgiLCJzY29wZXMiOiJjYWNoZSJ9.jOFRg8JJfpnHv-82sryXdZKXSnLrDijysp6RKtpW2Fk'

      # - name: Enable LLD
        # run: sudo ./ci/enable-lld.sh

      - name: Cache cargo registry
        uses: actions/cache@v1
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v1
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Run checks and tests
        run: |
          nix-shell \
            --run "pushd compiler/builtins/bitcode; ./run-tests.sh; popd; cargo fmt --all -- --check; cargo clippy -- -D warnings; cargo test --release"
