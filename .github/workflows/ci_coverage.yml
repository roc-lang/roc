on:
  workflow_call:
  workflow_dispatch:

name: CI Parser Coverage

# Do not add permissions here! Configure them at the job level!
permissions: {}

jobs:
  # Parser code coverage runs on macOS ARM where kcov works correctly.
  # This runs in parallel with main CI and doesn't block it.
  # Note: kcov doesn't work on Linux with Zig binaries (reports 0% coverage).
  parser-coverage:
    runs-on: macos-15
    timeout-minutes: 360  # 6 hour timeout for coverage
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
      - uses: mlugg/setup-zig@8d6198c65fb0feaa111df26e6b467fea8345e46f # ratchet:mlugg/setup-zig@v2.0.5
        with:
          version: 0.15.2
          use-cache: true

      - name: Install kcov
        run: brew install kcov

      - name: Run Parser Coverage
        run: |
          zig build coverage

      - name: Upload Coverage Report
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # ratchet:actions/upload-artifact@v4
        if: always()
        with:
          name: parser-coverage-report
          path: kcov-output/parser/
          retention-days: 7
